version: '3.7'

volumes:
  db_data:

services:
  traefik:
    image: traefik:v2.6.0
    container_name: traefik
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml
      - ./traefik/conf.d:/etc/traefik/conf.d
    labels:
      - traefik.enable=true

  server:
    build:
      context: ./iot-vega-server
    restart: always
    depends_on:
      - db
    ports:
      - "8001:8001/udp"
      - "8002:8002"

  db:
    image: mysql:8.0.28
    restart: always
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - db_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: "${DB_PASS}"
      MYSQL_DATABASE: "${DB_NAME}"

  admin-tool:
    build:
      context: ./iot-vega-admin
    restart: always
    depends_on:
      - server
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin-tool.rule=Host(`admin-tool.local`)"
      - "traefik.http.routers.admin-tool.service=admin-tool-service"

#      - "traefik.http.routers.admin-tool-tls.rule=Host(`admin-tool.local`)"
#      - "traefik.http.routers.admin-tool-tls.tls=true"
#      - "traefik.http.routers.admin-tool-tls.service=admin-tool-service"

      - "traefik.http.services.admin-tool-service.loadbalancer.server.port=80"

  pulse:
    build:
      context: ./iot-vega-pulse
    restart: always
    depends_on:
      - server
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pulse.rule=Host(`pulse.local`)"
      - "traefik.http.routers.pulse.service=pulse-service"

#      - "traefik.http.routers.pulse-tls.rule=Host(`pulse.local`)"
#      - "traefik.http.routers.pulse-tls.tls=true"
#      - "traefik.http.routers.pulse-tls.service=pulse-service"

      - "traefik.http.services.pulse-service.loadbalancer.server.port=80"

  phpmyadmin:
    image: phpmyadmin:5.1.1
    restart: always
    depends_on:
      - db
    environment:
      - PMA_HOST=db
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.phpmyadmin.rule=Host(`phpmyadmin.local`)"
      - "traefik.http.routers.phpmyadmin.service=phpmyadmin-service"

#      - "traefik.http.routers.phpmyadmin-tls.rule=Host(`phpmyadmin.local`)"
#      - "traefik.http.routers.phpmyadmin-tls.tls=true"
#      - "traefik.http.routers.phpmyadmin-tls.service=phpmyadmin-service"

      - "traefik.http.services.phpmyadmin-service.loadbalancer.server.port=80"

  restic:
    image: lobaro/restic-backup-docker:1.3.1-0.9.6
    privileged: true
    init: true
    restart: always
    cpus: 2.5
    volumes:
      - /mnt/md0/docker-data:/data:ro
      - ~/.ssh:/root/.ssh:ro
    environment:
      - RESTIC_PASSWORD
      - RESTIC_REPOSITORY
      - RESTIC_TAG=docker-data
      - BACKUP_CRON=30 0 * * * # time in UTC
      - RESTIC_FORGET_ARGS=--keep-daily 14 --keep-weekly 6 --keep-monthly 12 --keep-yearly 10
